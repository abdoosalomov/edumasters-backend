name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allow manual triggering

env:
  NODE_VERSION: '20'

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        command_timeout: 10m
        script: |
          set -e
          cd /root/edumasters-backend
          
          echo "🚀 Starting deployment at $(date)"
          
          # Use the deployment script
          if [ -f "scripts/deploy.sh" ]; then
            echo "📝 Using deployment script"
            chmod +x scripts/deploy.sh
            ./scripts/deploy.sh
          else
            echo "📝 Using manual deployment steps"
            echo "[PULLING LATEST CODE]"
            git pull origin main
            echo "[INSTALLING DEPENDENCIES]"
            npm ci
            echo "[GENERATING PRISMA CLIENT]"
            npx prisma generate
            echo "[BUILDING PROJECT]"
            npm run build
            echo "[RESTARTING PM2]"
            pm2 restart edumasters || pm2 start ecosystem.config.js
            pm2 save
            echo "[DEPLOYMENT COMPLETE]"
          fi
          
          echo "✅ Deployment completed successfully at $(date)"
          echo "🌐 Application status:"
          pm2 list
          
    - name: Health Check & Commit Verification
      uses: appleboy/ssh-action@v1.0.3
      if: success()
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        script: |
          echo "🔍 Performing health check..."
          sleep 10
          
          # Check if PM2 process is running
          if pm2 describe edumasters | grep -q "online"; then
            echo "✅ Application is running successfully"
            echo "📊 Process status:"
            pm2 describe edumasters
          else
            echo "❌ Application health check failed"
            echo "📋 Process logs:"
            pm2 logs edumasters --lines 20
            exit 1
          fi
          
          echo ""
          echo "🔍 Verifying deployed commit..."
          
          # Get current commit from health endpoint
          DEPLOYED_COMMIT=$(curl -s https://edumasters.abdusalomov.uz/health | jq -r '.commit' 2>/dev/null || echo "unknown")
          EXPECTED_COMMIT="${{ github.sha }}"
          
          echo "Expected commit: $EXPECTED_COMMIT"
          echo "Deployed commit: $DEPLOYED_COMMIT"
          
          if [ "$DEPLOYED_COMMIT" = "$EXPECTED_COMMIT" ]; then
            echo "✅ Commit verification successful! Deployed version matches expected commit."
          elif [ "$DEPLOYED_COMMIT" = "unknown" ]; then
            echo "⚠️  Could not retrieve commit from health endpoint, but application is running"
            echo "🔍 Checking git commit on server..."
            cd /root/edumasters-backend
            SERVER_COMMIT=$(git rev-parse HEAD)
            echo "Server git commit: $SERVER_COMMIT"
            if [ "$SERVER_COMMIT" = "$EXPECTED_COMMIT" ]; then
              echo "✅ Server git commit matches expected commit"
            else
              echo "❌ Server git commit does not match expected commit"
              exit 1
            fi
          else
            echo "❌ Commit verification failed! Deployed version does not match expected commit."
            exit 1
          fi
          
    - name: Deployment Summary
      if: always()
      run: |
        echo "## Deployment Summary 📋" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ job.status }}" == "success" ]; then
          echo "✅ **Status**: Deployment successful!" >> $GITHUB_STEP_SUMMARY
          echo "🌐 **URL**: https://edumasters.abdusalomov.uz" >> $GITHUB_STEP_SUMMARY
          echo "🔍 **Health Check**: Application verified and running" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Commit Verification**: Deployed version matches expected commit" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Status**: Deployment failed!" >> $GITHUB_STEP_SUMMARY
          echo "🔍 Check the logs above for details." >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
